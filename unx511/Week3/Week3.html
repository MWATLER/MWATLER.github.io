<h1>Week 3 - January 25-29</h1>

<h3>Introduction</h3>
<p>We will look at programming concepts and file I/O. In Linux, everything is a file, so it is important to know how to 
use them. We will also look at IOCTLs which are user-space calls into the Linux kernel.</p>
<h3>Videos</h3>
<table>
  <tr><td>File I/O</td><td><a href="https://www.youtube.com/watch?v=dP3N8g7h8gY" target="_blank">Linux file input/output</a></td></tr>
  <tr><td></td><td><a href="https://www.youtube.com/watch?v=BQJBe4IbsvQ" target="_blank">open() vs fopen()</a></td></tr>
  <tr><td>IOCTLs</td><td><a href="https://www.youtube.com/watch?v=-sigllMLte4" target="_blank">Linux IOCTL's</a></td></tr>
</table>

<h3>Quiz</h3>
<ul>
    <li><b>Quiz 2</b> (January 25)  will be on File I/O. Study Chapter 4 (System Programming Concepts) of
    <!--<li><a href="Quiz2.docx" target="_blank">Quiz 2</a> (July 10)  will be on File I/O. Study Chapter 4 (System Programming Concepts) of-->
    <a href="../The%20Linux%20Programming%20Interface%20-%20A%20Linux%20and%20UNIX%20System%20Programming%20Handbook.pdf" target="_blank">The Linux Programming Interface</a>.</li>
</ul>

<h3>Lecture Material</h3>
<ul>
<li>File I/O and IOCTLs - Chapter 4 of
  <a href="../The%20Linux%20Programming%20Interface%20-%20A%20Linux%20and%20UNIX%20System%20Programming%20Handbook.pdf" target="_blank">The Linux Programming Interface</a></li>
<li><a href="https://www.linuxjournal.com/article/6908" target="_blank">Controlling Hardware with ioctls</a>.</li>
</ul>

<h3>Labs</h3>
<ul>
  <li><a href="../Labs/Lab1/Lab1.html" target="_blank">Lab 1</a> (due January 29) - monitoring process memory usage.</li>
  <li><a href="../Labs/Lab2/Lab2.html" target="_blank">Lab 2</a> (due February 5) - using a static library.</li>
</ul>

<h3>Assignment(s)</h3>
<p>None.</p>

<h3>Sample Code</h3>
<p><em>File I/O</em></p>
<ul>
  <li>For an example of a program that simply copies a file from one location to another, see <a href="SimpleFile/SimpleFile.cpp" target="_blank">SimpleFile.cpp</a>.</li>
  <li>For an example of a program that does exactly the same thing but uses lseek to start 100 bytes into the input file, see <a href="SimpleFile/SeekFile.cpp" target="_blank">SeekFile.cpp</a>.</li>
  <li>For a simple makefile to create these, see <a href="SimpleFile/Makefile" target="_blank">Makefile</a>.</li>
  <li>The C library function fopen is compared with the Linux system function open via two test files - <a href="speedTest/openTest.cpp" target="_blank">openTest.cpp</a> and <a href="speedTest/fopenTest.cpp" target="_blank">fopenTest.cpp</a>. They both copy large amounts of data (<a href="speedTest/LargeOpen.txt" target="_blank">LargeOpen.txt</a> and <a href="speedTest/LargeFOpen.txt" target="_blank">LargeFOpen.txt</a>) and the time to copy is measured as a function of open's buffer size. For the makefile see <a href="speedTest/Makefile" target="_blank">Makefile</a>.</li>
</ul>

<p><em>IOCTLs</em></p>
<ul>
  <li>For an introduction to IOCTL's see <a href="https://www.linuxjournal.com/article/6908" target="_blank">Controlling Hardware with ioctls</a>.</li>
  <li>For sample code using IOCTL's see <a href="diskDrive/diskDrive.cpp" target="_blank">diskDrive.cpp</a>. This performs IOCTL's on the
  device driver for two file systems to get sector size, number of head, cylinders etc... Documentation on how to use this IOCTL
  can be found at <a href="https://www.kernel.org/doc/Documentation/ioctl/hdio.txt" target="_blank">Summary of HDIO_ IOCTL calls</a> and
  <a href="https://man7.org/linux/man-pages/man4/sd.4.html" target="_blank">sd - driver for SCSI disk drives</a>.</li>
</ul>

<p><em>Device Drivers (out of scope)</em></p>
<ul>
  <li>For a tutorial on how to write device drivers see
    <a href="https://www.apriorit.com/dev-blog/195-simple-driver-for-linux-os" target="_blank">Linux Device Drivers: Tutorial for Linux Driver Development</a>.</li>
  <li>A kernel driver has been written that simply passes a hello message from kernel space to user space.
  See <a href="device_driver/kernel/Makefile" target="_blank">Makefile</a>,
  <a href="device_driver/kernel/device_file.h" target="_blank">device_file.h</a>,
  <a href="device_driver/kernel/device_file.c" target="_blank">device_file.c</a>, and
  <a href="device_driver/kernel/main.c" target="_blank">main.c</a>. This makefile creates a kernel module <b>simple-module.ko</b> which is installed with the following command (note: you have to be super-user):<br>
  $ <em>sudo insmod simple-module.ko</em><br>
  The kernel module can be removed with:<br>
  $ <em>sudo rmmod simple-module.ko</em><br>
  The Makefile in this example has rules for <b>insmod</b> and <b>rmmod</b> (make load, make unload).<br>
  You can look in <b>/proc/modules</b> to see the name of the driver (simple-driver).
  You can also look in <b>/proc/devices</b> to see that the simple-driver entry has been added with its major number.<br>
  To access this driver from user space, you have to treat it as a file. To do so, <b>simple-driver</b> has to be added to the <b>/dev</b> directory with its major number.
  This can be accomplished as follows, assuming its major number is 250:<br>
  $ <em>sudo mknod /dev/simple-driver c 250 0</em><br>
  If you look inside the <b>/dev</b> directory, you should now see an entry <b>simple-driver</b>.<br>
  The following command will remove simple-driver from /dev:<br>
  $ <em>sudo unlink /dev/simple-driver</em></li>
  <li>A user application for calling this kernel module can be found in the file <a href="device_driver/user/user_file.cpp" target="_blank">user_file.cpp</a>.
    For the makefile see <a href="device_driver/user/Makefile" target="_blank">Makefile</a>. The user application <b>user_file</b> opens <b>/dev/simple-driver</b> and executes a <b>read()</b>,
  as if the device were a file. Be sure to run <b>user_file</b> as super-user.</li>
  <li>You can see a list of kernel modules with:<br>
  $ <a href="http://man7.org/linux/man-pages/man8/lsmod.8.html" target="_blank">lsmod</a><br>
  You can see kernel debug messages with:<br>
  $ <a href="http://man7.org/linux/man-pages/man1/dmesg.1.html" target="_blank">dmesg</a><br>
  You can see kernel debug messages continuously with:<br>
  $ <em>dmesg -wH</em><br>
  With the commands <a href="http://man7.org/linux/man-pages/man8/insmod.8.html" target="_blank">insmod</a> and
  <a href="http://man7.org/linux/man-pages/man8/rmmod.8.html" target="_blank">rmmod</a>, modules can be added and removed from the Linux kernel without rebooting the machine!!
  The writing of kernel drivers is out of scope for this course but you have to learn how to use them.</li>
</ul>
